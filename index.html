<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Galer√≠a QSL por Indicativo</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Mini estilos r√°pidos para la galer√≠a */
    .galeria {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    .galeria img {
      cursor: pointer; /* Indica que se puede hacer clic */
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <!-- BLOQUE HEADER -->
  <div class="header">
    <div class="header-content">
      <img src="logo-gadtm.png" alt="Logo Izquierdo" class="logo-side">
      <h1>üîç Buscar QSL por Indicativo üì°</h1>
      <img src="logo-qrz.png" alt="Logo Derecho" class="logo-side">
      <p>Ingres√° tu indicativo para ver las QSLs:</p>
      <input type="text" id="callsignInput" placeholder="Ej: LU1ABC">
      <button onclick="cargarGaleria()">Buscar</button>
    </div>

    <!-- BLOQUE GALER√çA -->
    <div class="galeria" id="galeria"></div>
  </div>

  <!-- BLOQUE SCRIPT -->
  <script>
    async function cargarGaleria() {
      // Obtener el valor del input y convertir a may√∫sculas
      const callSign = document.getElementById("callsignInput").value.trim().toUpperCase();
      const galeria = document.getElementById("galeria");
      galeria.innerHTML = ""; // Limpiar la galer√≠a antes de cargar nuevas im√°genes

      if (!callSign) {
        alert("Por favor ingres√° un indicativo.");
        return;
      }

      // URL de la funci√≥n serverless en Netlify que devuelve JSON con im√°genes
      const url = `/.netlify/functions/buscarQSL?callSign=${callSign}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("No se pudo acceder a la galer√≠a");
        const images = await res.json();

        if (!images.length) {
          galeria.innerHTML = `<p>No se encontraron QSLs para <strong>${callSign}</strong>.</p>`;
          return;
        }

        // BLOQUE RECORRER IM√ÅGENES
        images.forEach(img => {
          if (!img.url) return; // saltar si no hay URL (ej. next_cursor)

          // Extraer la fecha de subida y formatearla a DDMMYY
          const fecha = new Date(img.created_at);
          const dd = String(fecha.getDate()).padStart(2, '0');
          const mm = String(fecha.getMonth() + 1).padStart(2, '0');
          const yy = String(fecha.getFullYear()).slice(-2);
          const fechaStr = `${dd}${mm}${yy}`;

          // Crear nombre del archivo: INDICATIVO_FECHA
          const fileName = `${callSign}_${fechaStr}.${img.format}`;

          // Crear elemento <img> para la miniatura
          const imgEl = document.createElement("img");
          imgEl.src = img.url;      // URL de Cloudinary
          imgEl.alt = fileName;     // texto alternativo
          imgEl.style.width = "200px"; // tama√±o miniatura

          // Evento click ‚Üí descarga autom√°tica de la imagen en tama√±o original
          imgEl.addEventListener("click", async () => {
            try {
              const res = await fetch(img.url);   // traer la imagen
              const blob = await res.blob();      // convertir a blob
              const blobUrl = URL.createObjectURL(blob); // URL temporal

              // Crear enlace temporal y forzar descarga
              const a = document.createElement("a");
              a.href = blobUrl;
              a.download = fileName;
              document.body.appendChild(a);
              a.click();       // dispara la descarga
              a.remove();      // limpiar el DOM
              URL.revokeObjectURL(blobUrl); // liberar memoria
            } catch (err) {
              console.error("Error al descargar la imagen:", err);
            }
          });

          // Agregar la miniatura a la galer√≠a
          galeria.appendChild(imgEl);
        });

      } catch (error) {
        galeria.innerHTML = `<p style="color: red;">‚ùå Error al consultar im√°genes para <strong>${callSign}</strong>.</p>`;
        console.error("Error al cargar la galer√≠a:", error);
      }
    }
  </script>

</body>
</html>
