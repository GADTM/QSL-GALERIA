
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Galer√≠a QSL por Indicativo</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="header">
    <div class="header-content">
      <img src="logo-gadtm.png" alt="Logo Izquierdo" class="logo-side">
      <h1>üîç Buscar QSL por Indicativo üì°</h1>
      <img src="logo-qrz.png" alt="Logo Derecho" class="logo-side">
      <p>Ingres√° tu indicativo para ver las QSLs:</p>
      <input type="text" id="callsignInput" placeholder="Ej: LU1ABC">
      <button onclick="cargarGaleria()">Buscar</button>
    </div>
    <div class="galeria" id="galeria"></div>
  </div>

  <script>
    async function cargarGaleria() {
      const callSign = document.getElementById("callsignInput").value.trim().toUpperCase();
      const galeria = document.getElementById("galeria");
      galeria.innerHTML = "";

      if (!callSign) {
        alert("Por favor ingres√° un indicativo.");
        return;
      }

      const url = `/.netlify/functions/buscarQSL?callSign=${callSign}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("No se pudo acceder a la galer√≠a");
        const images = await res.json();

        if (!images.length) {
          galeria.innerHTML = `<p>No se encontraron QSLs para <strong>${callSign}</strong>.</p>`;
          return;
        }

  // Proceso de imagenes de las QSL
  images.forEach(img => {
  if (!img.url) return;
  // Indicativo en may√∫sculas
  const callSignUpper = callSign.toUpperCase();
  // Extraer fecha de subida y formatea a DDMMAA
  const fecha = new Date(img.created_at);
  const dd = String(fecha.getDate()).padStart(2, '0');
  const mm = String(fecha.getMonth() + 1).padStart(2, '0');
  const yy = String(fecha.getFullYear()).slice(-2);
  const fechaStr = `${dd}${mm}${yy}`;
  const fileName = `${callSignUpper}_${fechaStr}.${img.format}`;

  const imgEl = document.createElement("img");
  imgEl.src = img.url;
  imgEl.alt = fileName;
  imgEl.style.width = "200px";
  imgEl.style.cursor = "pointer";

  // Al hacer clic descargamos la imagen
  imgEl.addEventListener("click", async () => {
    const res = await fetch(img.url);
    const blob = await res.blob();
    const blobUrl = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = blobUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(blobUrl);
  });

  galeria.appendChild(imgEl);
});


      } catch (error) {
        galeria.innerHTML = `<p style="color: red;">‚ùå Error al consultar im√°genes para <strong>${callSign}</strong>.</p>`;
        console.error("Error al cargar la galer√≠a:", error);
      }
    }
  </script>
</body>
</html>
